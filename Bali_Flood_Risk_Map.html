<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bali Flood Risk Map - Villa Investment Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --navy: #1a365d;
            --navy-light: #2c5282;
            --gold: #d4af37;
            --gold-light: #f0d875;
            --gold-gradient: linear-gradient(135deg, #d4af37 0%, #f0d875 50%, #d4af37 100%);
            --white: #ffffff;
            --off-white: #f8f6f1;
            --light-gray: #e8e4dc;
            --gray: #6b7280;
            --risk-low: #22c55e;
            --risk-medium: #eab308;
            --risk-high: #f97316;
            --risk-critical: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, var(--navy) 0%, #0f172a 100%);
            min-height: 100vh;
            color: var(--navy);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 30px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-gold {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--navy);
        }

        .btn-gold:hover {
            background: var(--gold-light);
        }

        /* Search Bar */
        .search-container {
            background: var(--white);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .search-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
        }

        .search-desc {
            font-size: 13px;
            color: var(--gray);
        }

        .search-box {
            display: flex;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .search-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
        }

        /* Search Result */
        .search-result {
            display: none;
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-result.safe {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2));
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .search-result.warning {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.2));
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .search-result.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-icon {
            font-size: 28px;
        }

        .result-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--navy);
        }

        .result-subtitle {
            font-size: 13px;
            color: var(--gray);
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .result-item {
            padding: 10px 14px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }

        .result-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
            margin-top: 2px;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Map Container */
        .map-container {
            background: var(--white);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .map-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .map-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .map-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .map-badge {
            padding: 6px 14px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--gold);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gold-light);
        }

        #map {
            height: 550px;
            width: 100%;
        }

        .map-legend {
            padding: 16px 24px;
            background: var(--off-white);
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .legend-dot.low { background: var(--risk-low); }
        .legend-dot.medium { background: var(--risk-medium); }
        .legend-dot.high { background: var(--risk-high); }
        .legend-dot.critical { background: var(--risk-critical); }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            padding: 18px 20px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .card-content {
            padding: 20px;
        }

        /* Region List */
        .region-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .region-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--off-white);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .region-item:hover {
            background: white;
            border-color: var(--gold);
            transform: translateX(4px);
        }

        .region-item.active {
            background: white;
            border-color: var(--gold);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .region-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .region-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--navy);
        }

        .risk-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-badge.low {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .risk-badge.medium {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
        }

        .risk-badge.high {
            background: rgba(249, 115, 22, 0.15);
            color: #ea580c;
        }

        .risk-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        /* Stats Card */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-box {
            padding: 14px;
            background: var(--off-white);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--navy);
        }

        .stat-label {
            font-size: 11px;
            color: var(--gray);
            margin-top: 4px;
        }

        /* Data Sources */
        .data-sources {
            padding: 16px 20px;
            background: var(--off-white);
            border-top: 1px solid var(--light-gray);
        }

        .sources-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .sources-list a {
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            font-size: 10px;
            color: var(--navy);
            text-decoration: none;
            transition: all 0.2s;
        }

        .sources-list a:hover {
            background: var(--gold);
            color: var(--navy);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px 24px;
            color: rgba(255,255,255,0.5);
            font-size: 13px;
        }

        .footer-brand {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        /* Custom Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 14px 16px;
            font-family: 'Inter', sans-serif;
        }

        .popup-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .popup-risk {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .popup-desc {
            font-size: 12px;
            color: var(--gray);
            line-height: 1.5;
        }

        .popup-btn {
            display: block;
            margin-top: 10px;
            padding: 8px 14px;
            background: var(--navy);
            color: white;
            text-align: center;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        /* User Marker */
        .user-marker {
            background: var(--gold);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Flood Zone Polygons */
        .flood-zone-high {
            fill: rgba(239, 68, 68, 0.3);
            stroke: #ef4444;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            #map {
                height: 400px;
            }

            .search-box {
                flex-direction: column;
            }

            .map-legend {
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <div class="logo">Bali Flood Risk Map</div>
                <div class="header-subtitle" data-i18n="subtitle">Villa Investment Risk Assessment Tool</div>
            </div>
            <div class="header-actions">
                <a href="Villa_ROI_Calculator.html" class="btn btn-gold" data-i18n="backToRoi">← ROI Simulator</a>
                <button class="btn" onclick="toggleLanguage()">
                    <span id="langToggleText">한국어</span>
                </button>
            </div>
        </header>

        <!-- Address Search -->
        <div class="search-container">
            <div class="search-header">
                <div class="search-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <div>
                    <div class="search-title" data-i18n="searchTitle">Check Villa Address</div>
                    <div class="search-desc" data-i18n="searchDesc">Enter a villa address to check flood risk at that location</div>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="addressInput" class="search-input" placeholder="Enter villa address in Bali..." data-i18n-placeholder="searchPlaceholder">
                <button class="search-btn" onclick="searchAddress()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                    <span data-i18n="searchBtn">Check Risk</span>
                </button>
            </div>
            <div id="searchResult" class="search-result"></div>
        </div>

        <div class="main-layout">
            <div class="map-container">
                <div class="map-header">
                    <span class="map-title" data-i18n="mapTitle">Interactive Flood Risk Map</span>
                    <div class="map-badges">
                        <span class="map-badge">BNPB Data</span>
                        <span class="map-badge">2020-2025</span>
                        <span class="map-badge" data-i18n="realtime">Real-time</span>
                    </div>
                </div>
                <div id="map"></div>
                <div class="map-legend">
                    <div class="legend-item">
                        <span class="legend-dot low"></span>
                        <span data-i18n="riskLow">Low Risk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot medium"></span>
                        <span data-i18n="riskMedium">Medium Risk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot high"></span>
                        <span data-i18n="riskHigh">High Risk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot critical"></span>
                        <span data-i18n="riskCritical">Critical Risk</span>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" data-i18n="statsTitle">Bali Flood Statistics</h2>
                    </div>
                    <div class="card-content">
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value">17+</div>
                                <div class="stat-label" data-i18n="majorFloods">Major Floods (5yr)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">6</div>
                                <div class="stat-label" data-i18n="regenciesAffected">Regencies Affected</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">66%</div>
                                <div class="stat-label" data-i18n="riskProbability">20yr Risk Prob.</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">Sep 2025</div>
                                <div class="stat-label" data-i18n="lastMajor">Last Major Event</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Region List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" data-i18n="regionListTitle">Investment Regions</h2>
                    </div>
                    <div class="card-content">
                        <div class="region-list" id="regionList"></div>
                    </div>
                    <div class="data-sources">
                        <div class="sources-title" data-i18n="dataSources">Official Data Sources</div>
                        <div class="sources-list">
                            <a href="https://gis.bnpb.go.id" target="_blank">BNPB Geoportal</a>
                            <a href="https://dibi.bnpb.go.id" target="_blank">DIBI</a>
                            <a href="https://inarisk.bnpb.go.id" target="_blank">inaRISK</a>
                            <a href="https://petabencana.id" target="_blank">PetaBencana</a>
                            <a href="https://thinkhazard.org" target="_blank">ThinkHazard</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-brand">Ryan Villa Investment Tools</div>
            <div data-i18n="footerNote">Data: BNPB, inaRISK, PetaBencana.id | For investment reference only</div>
        </footer>
    </div>

    <script>
        let currentLang = 'en';
        let map;
        let userMarker = null;
        let floodZones = [];

        const translations = {
            en: {
                subtitle: "Villa Investment Risk Assessment Tool",
                backToRoi: "← ROI Simulator",
                searchTitle: "Check Villa Address",
                searchDesc: "Enter a villa address to check flood risk at that location",
                searchPlaceholder: "Enter villa address in Bali...",
                searchBtn: "Check Risk",
                mapTitle: "Interactive Flood Risk Map",
                realtime: "Real-time",
                riskLow: "Low Risk",
                riskMedium: "Medium Risk",
                riskHigh: "High Risk",
                riskCritical: "Critical Risk",
                statsTitle: "Bali Flood Statistics",
                majorFloods: "Major Floods (5yr)",
                regenciesAffected: "Regencies Affected",
                riskProbability: "20yr Risk Prob.",
                lastMajor: "Last Major Event",
                regionListTitle: "Investment Regions",
                dataSources: "Official Data Sources",
                footerNote: "Data: BNPB, inaRISK, PetaBencana.id | For investment reference only",
                resultSafe: "Low Flood Risk Area",
                resultSafeDesc: "This location is in a relatively safe zone",
                resultWarning: "Moderate Flood Risk",
                resultWarningDesc: "Some flooding history in this area",
                resultDanger: "High Flood Risk Area",
                resultDangerDesc: "Significant flood events recorded nearby",
                nearestZone: "Nearest Risk Zone",
                distanceToRisk: "Distance to Risk",
                floodFrequency: "Flood Frequency",
                recommendation: "Recommendation"
            },
            ko: {
                subtitle: "빌라 투자 위험 평가 도구",
                backToRoi: "← ROI 시뮬레이터",
                searchTitle: "빌라 주소 확인",
                searchDesc: "빌라 주소를 입력하여 침수 위험을 확인하세요",
                searchPlaceholder: "발리 빌라 주소 입력...",
                searchBtn: "위험 확인",
                mapTitle: "대화형 침수 위험 지도",
                realtime: "실시간",
                riskLow: "낮은 위험",
                riskMedium: "중간 위험",
                riskHigh: "높은 위험",
                riskCritical: "심각한 위험",
                statsTitle: "발리 침수 통계",
                majorFloods: "대형 침수 (5년)",
                regenciesAffected: "피해 지역",
                riskProbability: "20년 위험 확률",
                lastMajor: "최근 대형 침수",
                regionListTitle: "투자 지역",
                dataSources: "공식 데이터 출처",
                footerNote: "데이터: BNPB, inaRISK, PetaBencana.id | 투자 참고용",
                resultSafe: "침수 위험 낮은 지역",
                resultSafeDesc: "이 위치는 비교적 안전한 구역입니다",
                resultWarning: "중간 침수 위험",
                resultWarningDesc: "이 지역에 일부 침수 이력이 있습니다",
                resultDanger: "침수 위험 높은 지역",
                resultDangerDesc: "인근에 상당한 침수 사건이 기록되어 있습니다",
                nearestZone: "가장 가까운 위험 구역",
                distanceToRisk: "위험 지역까지 거리",
                floodFrequency: "침수 빈도",
                recommendation: "권고사항"
            }
        };

        // Flood risk zones with polygon data - Based on BNPB historical flood data 2020-2025
        // Flood zones expanded to reflect actual affected areas along river corridors and lowlands
        const regions = [
            {
                id: 'canggu',
                name: 'Canggu',
                nameKo: '짱구',
                coords: [-8.6478, 115.1385],
                risk: 'high',
                riskScore: 75,
                frequency: '2-3/year',
                floodZones: [
                    // Tukad Petanu River corridor - major flooding area
                    { name: 'Tukad Petanu Corridor', coords: [
                        [-8.6300, 115.1250], [-8.6350, 115.1200], [-8.6450, 115.1180],
                        [-8.6550, 115.1220], [-8.6650, 115.1280], [-8.6700, 115.1350],
                        [-8.6680, 115.1450], [-8.6600, 115.1500], [-8.6500, 115.1480],
                        [-8.6400, 115.1420], [-8.6320, 115.1350]
                    ]},
                    // Berawa lowlands - frequent flooding
                    { name: 'Berawa Lowlands', coords: [
                        [-8.6550, 115.1480], [-8.6580, 115.1520], [-8.6620, 115.1580],
                        [-8.6680, 115.1650], [-8.6720, 115.1700], [-8.6700, 115.1780],
                        [-8.6620, 115.1750], [-8.6550, 115.1680], [-8.6500, 115.1600],
                        [-8.6480, 115.1520]
                    ]},
                    // Batu Bolong area - coastal flooding
                    { name: 'Batu Bolong', coords: [
                        [-8.6480, 115.1300], [-8.6520, 115.1280], [-8.6580, 115.1320],
                        [-8.6620, 115.1380], [-8.6600, 115.1450], [-8.6550, 115.1420],
                        [-8.6500, 115.1380], [-8.6470, 115.1340]
                    ]},
                    // Cemagi rice fields - seasonal flooding
                    { name: 'Cemagi', coords: [
                        [-8.6200, 115.1100], [-8.6280, 115.1080], [-8.6380, 115.1120],
                        [-8.6420, 115.1200], [-8.6380, 115.1280], [-8.6300, 115.1260],
                        [-8.6220, 115.1200], [-8.6180, 115.1150]
                    ]}
                ],
                recommendation: {
                    en: 'High flood risk along Tukad Petanu river. Avoid Berawa lowlands and Batu Bolong coastal areas. North Canggu highlands safer.',
                    ko: '뚜깟 쁘따누 강 유역 홍수 위험 높음. 베라와 저지대와 바투볼롱 해안 지역 피하세요. 북부 짱구 고지대가 안전.'
                }
            },
            {
                id: 'seminyak',
                name: 'Seminyak',
                nameKo: '스미냑',
                coords: [-8.6913, 115.1683],
                risk: 'high',
                riskScore: 70,
                frequency: '2-3/year',
                floodZones: [
                    // Sunset Road corridor - notorious flooding
                    { name: 'Sunset Road Corridor', coords: [
                        [-8.6900, 115.1550], [-8.6950, 115.1520], [-8.7020, 115.1560],
                        [-8.7080, 115.1620], [-8.7100, 115.1700], [-8.7050, 115.1750],
                        [-8.6980, 115.1720], [-8.6920, 115.1680], [-8.6880, 115.1620]
                    ]},
                    // Tukad Mati drainage basin
                    { name: 'Tukad Mati Basin', coords: [
                        [-8.6780, 115.1700], [-8.6850, 115.1680], [-8.6920, 115.1720],
                        [-8.6980, 115.1800], [-8.6950, 115.1880], [-8.6880, 115.1850],
                        [-8.6800, 115.1800], [-8.6750, 115.1750]
                    ]},
                    // Petitenget to Oberoi stretch
                    { name: 'Petitenget-Oberoi', coords: [
                        [-8.6820, 115.1580], [-8.6880, 115.1550], [-8.6950, 115.1600],
                        [-8.6920, 115.1680], [-8.6850, 115.1650], [-8.6800, 115.1620]
                    ]},
                    // Southern Seminyak lowlands
                    { name: 'South Seminyak', coords: [
                        [-8.7000, 115.1650], [-8.7080, 115.1620], [-8.7150, 115.1680],
                        [-8.7120, 115.1780], [-8.7050, 115.1750], [-8.6980, 115.1700]
                    ]}
                ],
                recommendation: {
                    en: 'Sunset Road floods almost every rainy season. Tukad Mati area prone to drainage overflow. Upper Petitenget relatively safer.',
                    ko: '선셋 로드는 거의 매 우기 침수. 뚜깟 마띠 지역 배수 범람 잦음. 상부 쁘띠뗑엣이 상대적으로 안전.'
                }
            },
            {
                id: 'ubud',
                name: 'Ubud',
                nameKo: '우붓',
                coords: [-8.5069, 115.2625],
                risk: 'medium',
                riskScore: 45,
                frequency: '1-2/year',
                floodZones: [
                    // Campuhan River valley
                    { name: 'Campuhan Valley', coords: [
                        [-8.4950, 115.2500], [-8.5020, 115.2480], [-8.5100, 115.2520],
                        [-8.5180, 115.2600], [-8.5150, 115.2700], [-8.5080, 115.2680],
                        [-8.5000, 115.2620], [-8.4950, 115.2560]
                    ]},
                    // Tjampuhan ridge lowlands
                    { name: 'Tjampuhan', coords: [
                        [-8.5050, 115.2580], [-8.5120, 115.2550], [-8.5180, 115.2620],
                        [-8.5150, 115.2720], [-8.5080, 115.2700], [-8.5030, 115.2650]
                    ]},
                    // Ubud rice terrace valleys
                    { name: 'Tegallalang Valley', coords: [
                        [-8.4300, 115.2750], [-8.4380, 115.2720], [-8.4450, 115.2780],
                        [-8.4480, 115.2880], [-8.4400, 115.2900], [-8.4320, 115.2850],
                        [-8.4280, 115.2800]
                    ]}
                ],
                recommendation: {
                    en: 'River valleys flood during heavy rain. Hillside and ridge properties are safe. Avoid properties in valley floors.',
                    ko: '폭우시 강 계곡 침수. 언덕/능선 매물은 안전. 계곡 바닥 매물 피하세요.'
                }
            },
            {
                id: 'sanur',
                name: 'Sanur',
                nameKo: '사누르',
                coords: [-8.7089, 115.2621],
                risk: 'low',
                riskScore: 30,
                frequency: '0.5-1/year',
                floodZones: [
                    // Coastal strip - minor tidal flooding
                    { name: 'Sanur Beach Road', coords: [
                        [-8.6950, 115.2620], [-8.7000, 115.2650], [-8.7100, 115.2680],
                        [-8.7200, 115.2700], [-8.7180, 115.2750], [-8.7080, 115.2720],
                        [-8.6980, 115.2680], [-8.6940, 115.2650]
                    ]}
                ],
                recommendation: {
                    en: 'Generally safe. Minor coastal flooding possible during king tides. Good drainage infrastructure.',
                    ko: '대체로 안전. 대조시 해안 경미한 침수 가능. 배수 인프라 양호.'
                }
            },
            {
                id: 'uluwatu',
                name: 'Uluwatu',
                nameKo: '울루와투',
                coords: [-8.8291, 115.0849],
                risk: 'low',
                riskScore: 20,
                frequency: '<0.5/year',
                floodZones: [],
                recommendation: {
                    en: 'Clifftop location = virtually zero flood risk. Premium location for luxury villas.',
                    ko: '절벽 위치 = 침수 위험 사실상 제로. 럭셔리 빌라 프리미엄 위치.'
                }
            },
            {
                id: 'nusadua',
                name: 'Nusa Dua',
                nameKo: '누사두아',
                coords: [-8.8005, 115.2316],
                risk: 'low',
                riskScore: 25,
                frequency: '<0.5/year',
                floodZones: [
                    // Minor lowland area
                    { name: 'Tanjung Benoa', coords: [
                        [-8.7550, 115.2280], [-8.7620, 115.2250], [-8.7700, 115.2300],
                        [-8.7680, 115.2380], [-8.7600, 115.2350], [-8.7540, 115.2320]
                    ]}
                ],
                recommendation: {
                    en: 'Resort-grade infrastructure with excellent drainage. Tanjung Benoa slightly lower-lying.',
                    ko: '리조트급 인프라로 배수 우수. 딴중 브노아만 약간 저지대.'
                }
            },
            {
                id: 'kuta',
                name: 'Kuta/Legian',
                nameKo: '꾸따/레기안',
                coords: [-8.7180, 115.1690],
                risk: 'critical',
                riskScore: 85,
                frequency: '3-4/year',
                floodZones: [
                    // Central Kuta - chronic flooding
                    { name: 'Kuta Center', coords: [
                        [-8.7050, 115.1650], [-8.7120, 115.1600], [-8.7200, 115.1650],
                        [-8.7280, 115.1720], [-8.7320, 115.1820], [-8.7280, 115.1900],
                        [-8.7180, 115.1880], [-8.7100, 115.1800], [-8.7050, 115.1720]
                    ]},
                    // Legian beach strip
                    { name: 'Legian', coords: [
                        [-8.6950, 115.1680], [-8.7020, 115.1650], [-8.7100, 115.1700],
                        [-8.7080, 115.1800], [-8.7000, 115.1780], [-8.6940, 115.1720]
                    ]},
                    // Airport road corridor
                    { name: 'Airport Road', coords: [
                        [-8.7200, 115.1750], [-8.7280, 115.1700], [-8.7400, 115.1780],
                        [-8.7500, 115.1900], [-8.7450, 115.1980], [-8.7350, 115.1920],
                        [-8.7250, 115.1850], [-8.7200, 115.1800]
                    ]},
                    // Tuban area near airport
                    { name: 'Tuban', coords: [
                        [-8.7350, 115.1650], [-8.7420, 115.1600], [-8.7520, 115.1680],
                        [-8.7550, 115.1800], [-8.7480, 115.1850], [-8.7400, 115.1780],
                        [-8.7350, 115.1720]
                    ]}
                ],
                recommendation: {
                    en: 'Most flood-prone area in South Bali. Poor drainage, flat terrain, high water table. NOT recommended for villa investment.',
                    ko: '남부 발리 최다 침수 지역. 배수 불량, 평지, 지하수위 높음. 빌라 투자 비추천.'
                }
            },
            {
                id: 'denpasar',
                name: 'Denpasar',
                nameKo: '덴파사르',
                coords: [-8.6705, 115.2126],
                risk: 'high',
                riskScore: 72,
                frequency: '2-3/year',
                floodZones: [
                    // Tukad Badung river corridor
                    { name: 'Tukad Badung Corridor', coords: [
                        [-8.6500, 115.2000], [-8.6580, 115.1950], [-8.6680, 115.2020],
                        [-8.6780, 115.2120], [-8.6850, 115.2250], [-8.6800, 115.2350],
                        [-8.6700, 115.2300], [-8.6600, 115.2200], [-8.6520, 115.2100]
                    ]},
                    // City center lowlands
                    { name: 'Denpasar Center', coords: [
                        [-8.6600, 115.2100], [-8.6700, 115.2050], [-8.6800, 115.2120],
                        [-8.6850, 115.2220], [-8.6800, 115.2300], [-8.6700, 115.2280],
                        [-8.6620, 115.2200]
                    ]},
                    // Southern Denpasar
                    { name: 'Renon-Sanglah', coords: [
                        [-8.6750, 115.2200], [-8.6850, 115.2150], [-8.6950, 115.2220],
                        [-8.6980, 115.2350], [-8.6900, 115.2400], [-8.6800, 115.2350],
                        [-8.6750, 115.2280]
                    ]},
                    // Sesetan area
                    { name: 'Sesetan', coords: [
                        [-8.6900, 115.2100], [-8.6980, 115.2050], [-8.7080, 115.2120],
                        [-8.7100, 115.2250], [-8.7020, 115.2300], [-8.6920, 115.2220]
                    ]}
                ],
                recommendation: {
                    en: 'Urban flooding common along Tukad Badung. Dense development, inadequate drainage. Residential area, not ideal for tourist villas.',
                    ko: '뚜깟 바둥 따라 도시 침수 잦음. 고밀도 개발, 배수 부족. 주거지역으로 관광 빌라에 부적합.'
                }
            }
        ];

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ko' : 'en';
            document.getElementById('langToggleText').textContent = currentLang === 'en' ? '한국어' : 'English';
            applyTranslations();
            renderRegionList();
        }

        function applyTranslations() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });
        }

        function getRiskColor(risk) {
            switch(risk) {
                case 'low': return '#22c55e';
                case 'medium': return '#eab308';
                case 'high': return '#f97316';
                case 'critical': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function getRiskLabel(risk) {
            const t = translations[currentLang];
            switch(risk) {
                case 'low': return t.riskLow;
                case 'medium': return t.riskMedium;
                case 'high': return t.riskHigh;
                case 'critical': return t.riskCritical;
                default: return risk;
            }
        }

        function initMap() {
            map = L.map('map').setView([-8.65, 115.2], 10);

            // Use CartoDB light tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Add BNPB flood hazard layer (WMS)
            try {
                const bnpbLayer = L.tileLayer.wms('https://gis.bnpb.go.id/server/services/inarisk/layer_bahaya_banjir_30/MapServer/WMSServer', {
                    layers: '0',
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.4
                });
                // Uncomment to enable: bnpbLayer.addTo(map);
            } catch(e) {
                console.log('BNPB layer not available');
            }

            // Add region markers and flood zones
            regions.forEach(region => {
                const color = getRiskColor(region.risk);

                // Add flood zone polygons
                region.floodZones.forEach(zone => {
                    if (zone.coords && zone.coords.length > 0) {
                        const polygon = L.polygon(zone.coords, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.3,
                            weight: 2
                        }).addTo(map);

                        polygon.bindPopup(`<b>${zone.name}</b><br>High flood risk zone`);
                        floodZones.push({ polygon, region, zone });
                    }
                });

                // Add region marker
                const marker = L.circleMarker(region.coords, {
                    radius: 18,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const name = currentLang === 'ko' ? region.nameKo : region.name;

                marker.bindPopup(`
                    <div class="popup-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${color}" stroke="${color}" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3" fill="white"/></svg> ${name}</div>
                    <span class="popup-risk risk-badge ${region.risk}">${getRiskLabel(region.risk)}</span>
                    <p class="popup-desc">${region.recommendation[currentLang]}</p>
                    <div style="margin-top:10px;font-size:12px;">
                        <strong>Flood Frequency:</strong> ${region.frequency}
                    </div>
                `);

                marker.on('click', () => {
                    map.flyTo(region.coords, 13);
                });
            });
        }

        function renderRegionList() {
            const container = document.getElementById('regionList');
            container.innerHTML = regions.map(region => {
                const name = currentLang === 'ko' ? region.nameKo : region.name;
                const color = getRiskColor(region.risk);

                return `
                    <div class="region-item" onclick="focusRegion('${region.id}')">
                        <div class="region-info">
                            <div class="region-icon" style="background: ${color}20;"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${color}" stroke="${color}" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3" fill="white"/></svg></div>
                            <div class="region-name">${name}</div>
                        </div>
                        <span class="risk-badge ${region.risk}">${region.riskScore}</span>
                    </div>
                `;
            }).join('');
        }

        function focusRegion(regionId) {
            const region = regions.find(r => r.id === regionId);
            if (region) {
                map.flyTo(region.coords, 14);
            }
        }

        // Address search using Nominatim (OpenStreetMap)
        async function searchAddress() {
            const address = document.getElementById('addressInput').value;
            if (!address) return;

            const resultDiv = document.getElementById('searchResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'search-result';
            resultDiv.innerHTML = '<div style="text-align:center;padding:20px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px;"><circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"/></svg>Searching...</div>';

            try {
                // Use Nominatim for geocoding
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Bali, Indonesia')}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    // Remove existing user marker
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    // Add new marker
                    userMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);

                    userMarker.bindPopup(`<b>Your Villa Location</b><br>${data[0].display_name}`).openPopup();

                    map.flyTo([lat, lon], 15);

                    // Check flood risk
                    const riskResult = checkFloodRisk(lat, lon);
                    displaySearchResult(riskResult, data[0].display_name);

                } else {
                    resultDiv.className = 'search-result warning';
                    resultDiv.innerHTML = `
                        <div class="result-header">
                            <span class="result-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></span>
                            <div>
                                <div class="result-title">Address Not Found</div>
                                <div class="result-subtitle">Try a more specific address or nearby landmark</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'search-result warning';
                resultDiv.innerHTML = `
                    <div class="result-header">
                        <span class="result-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></span>
                        <div>
                            <div class="result-title">Search Error</div>
                            <div class="result-subtitle">${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }

        function checkFloodRisk(lat, lon) {
            const t = translations[currentLang];
            let nearestRegion = null;
            let minDistance = Infinity;
            let inFloodZone = false;

            // Check each region
            regions.forEach(region => {
                const distance = getDistance(lat, lon, region.coords[0], region.coords[1]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestRegion = region;
                }

                // Check if in flood zone polygon
                region.floodZones.forEach(zone => {
                    if (isPointInPolygon([lat, lon], zone.coords)) {
                        inFloodZone = true;
                    }
                });
            });

            // Determine risk level
            let riskLevel, riskClass;
            if (inFloodZone || (nearestRegion && nearestRegion.riskScore >= 70 && minDistance < 2)) {
                riskLevel = 'danger';
                riskClass = 'danger';
            } else if (nearestRegion && nearestRegion.riskScore >= 40 && minDistance < 3) {
                riskLevel = 'warning';
                riskClass = 'warning';
            } else {
                riskLevel = 'safe';
                riskClass = 'safe';
            }

            return {
                riskLevel,
                riskClass,
                nearestRegion,
                distance: minDistance,
                inFloodZone
            };
        }

        function displaySearchResult(result, address) {
            const t = translations[currentLang];
            const resultDiv = document.getElementById('searchResult');

            let icon, title, desc;
            if (result.riskLevel === 'danger') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                title = t.resultDanger;
                desc = t.resultDangerDesc;
            } else if (result.riskLevel === 'warning') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
                title = t.resultWarning;
                desc = t.resultWarningDesc;
            } else {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                title = t.resultSafe;
                desc = t.resultSafeDesc;
            }

            const regionName = result.nearestRegion ?
                (currentLang === 'ko' ? result.nearestRegion.nameKo : result.nearestRegion.name) : 'Unknown';

            resultDiv.className = `search-result ${result.riskClass}`;
            resultDiv.innerHTML = `
                <div class="result-header">
                    <span class="result-icon">${icon}</span>
                    <div>
                        <div class="result-title">${title}</div>
                        <div class="result-subtitle">${desc}</div>
                    </div>
                </div>
                <div class="result-details">
                    <div class="result-item">
                        <div class="result-label">${t.nearestZone}</div>
                        <div class="result-value">${regionName}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.distanceToRisk}</div>
                        <div class="result-value">${result.distance.toFixed(1)} km</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.floodFrequency}</div>
                        <div class="result-value">${result.nearestRegion?.frequency || 'N/A'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.recommendation}</div>
                        <div class="result-value" style="font-size:12px;">${result.nearestRegion?.recommendation[currentLang] || '-'}</div>
                    </div>
                </div>
            `;
        }

        // Helper: Calculate distance between two points (km)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Helper: Check if point is in polygon
        function isPointInPolygon(point, polygon) {
            if (!polygon || polygon.length < 3) return false;

            let inside = false;
            const x = point[0], y = point[1];

            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];

                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }

            return inside;
        }

        // Enter key search
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addressInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchAddress();
            });

            initMap();
            renderRegionList();
        });
    </script>
</body>
</html>
