<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bali Flood Risk Map - Villa Investment Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --navy: #1a365d;
            --navy-light: #2c5282;
            --gold: #d4af37;
            --gold-light: #f0d875;
            --gold-gradient: linear-gradient(135deg, #d4af37 0%, #f0d875 50%, #d4af37 100%);
            --white: #ffffff;
            --off-white: #f8f6f1;
            --light-gray: #e8e4dc;
            --gray: #6b7280;
            --risk-low: #22c55e;
            --risk-medium: #eab308;
            --risk-high: #f97316;
            --risk-critical: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, var(--navy) 0%, #0f172a 100%);
            min-height: 100vh;
            color: var(--navy);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 30px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-gold {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--navy);
        }

        .btn-gold:hover {
            background: var(--gold-light);
        }

        /* Search Bar */
        .search-container {
            background: var(--white);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .search-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
        }

        .search-desc {
            font-size: 13px;
            color: var(--gray);
        }

        .search-box {
            display: flex;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .search-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
        }

        /* Search Result */
        .search-result {
            display: none;
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-result.safe {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2));
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .search-result.warning {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.2));
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .search-result.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-icon {
            font-size: 28px;
        }

        .result-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--navy);
        }

        .result-subtitle {
            font-size: 13px;
            color: var(--gray);
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .result-item {
            padding: 10px 14px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }

        .result-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
            margin-top: 2px;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Map Container */
        .map-container {
            background: var(--white);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .map-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .map-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .map-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .map-badge {
            padding: 6px 14px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--gold);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gold-light);
        }

        #map {
            height: 550px;
            width: 100%;
        }

        .map-legend {
            padding: 16px 24px;
            background: var(--off-white);
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
        }

        .legend-dot {
            width: 20px;
            height: 14px;
            border-radius: 4px;
            opacity: 0.7;
        }

        .legend-dot.low { background: var(--risk-low); opacity: 0.5; }
        .legend-dot.medium { background: var(--risk-medium); opacity: 0.6; }
        .legend-dot.high { background: var(--risk-high); opacity: 0.7; }
        .legend-dot.critical { background: var(--risk-critical); opacity: 0.75; }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            padding: 18px 20px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .card-content {
            padding: 20px;
        }

        /* Region List */
        .region-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .region-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--off-white);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .region-item:hover {
            background: white;
            border-color: var(--gold);
            transform: translateX(4px);
        }

        .region-item.active {
            background: white;
            border-color: var(--gold);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .region-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .region-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--navy);
        }

        .risk-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-badge.low {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .risk-badge.medium {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
        }

        .risk-badge.high {
            background: rgba(249, 115, 22, 0.15);
            color: #ea580c;
        }

        .risk-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        /* Stats Card */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-box {
            padding: 14px;
            background: var(--off-white);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--navy);
        }

        .stat-label {
            font-size: 11px;
            color: var(--gray);
            margin-top: 4px;
        }

        /* Data Sources */
        .data-sources {
            padding: 16px 20px;
            background: var(--off-white);
            border-top: 1px solid var(--light-gray);
        }

        .sources-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .sources-list a {
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            font-size: 10px;
            color: var(--navy);
            text-decoration: none;
            transition: all 0.2s;
        }

        .sources-list a:hover {
            background: var(--gold);
            color: var(--navy);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px 24px;
            color: rgba(255,255,255,0.5);
            font-size: 13px;
        }

        .footer-brand {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        /* Custom Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 14px 16px;
            font-family: 'Inter', sans-serif;
        }

        .popup-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .popup-risk {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .popup-desc {
            font-size: 12px;
            color: var(--gray);
            line-height: 1.5;
        }

        .popup-btn {
            display: block;
            margin-top: 10px;
            padding: 8px 14px;
            background: var(--navy);
            color: white;
            text-align: center;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        /* User Marker */
        .user-marker {
            background: var(--gold);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Flood Zone Polygons */
        .flood-zone-high {
            fill: rgba(239, 68, 68, 0.3);
            stroke: #ef4444;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            #map {
                height: 400px;
            }

            .search-box {
                flex-direction: column;
            }

            .map-legend {
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <div class="logo">Bali Flood Risk Map</div>
                <div class="header-subtitle" data-i18n="subtitle">Villa Investment Risk Assessment Tool</div>
            </div>
            <div class="header-actions">
                <a href="Villa_ROI_Calculator.html" class="btn btn-gold" data-i18n="backToRoi">← ROI Simulator</a>
                <button class="btn" onclick="toggleLanguage()">
                    <span id="langToggleText">한국어</span>
                </button>
            </div>
        </header>

        <!-- Address Search -->
        <div class="search-container">
            <div class="search-header">
                <div class="search-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <div>
                    <div class="search-title" data-i18n="searchTitle">Check Villa Address</div>
                    <div class="search-desc" data-i18n="searchDesc">Enter a villa address to check flood risk at that location</div>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="addressInput" class="search-input" placeholder="Enter villa address in Bali..." data-i18n-placeholder="searchPlaceholder">
                <button class="search-btn" onclick="searchAddress()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                    <span data-i18n="searchBtn">Check Risk</span>
                </button>
            </div>
            <div id="searchResult" class="search-result"></div>
        </div>

        <div class="main-layout">
            <div class="map-container">
                <div class="map-header">
                    <span class="map-title" data-i18n="mapTitle">Interactive Flood Risk Map</span>
                    <div class="map-badges">
                        <span class="map-badge">BNPB Data</span>
                        <span class="map-badge">2020-2025</span>
                        <span class="map-badge" data-i18n="realtime">Real-time</span>
                    </div>
                </div>
                <div id="map"></div>
                <div class="map-legend">
                    <div class="legend-item">
                        <span class="legend-dot low"></span>
                        <span data-i18n="riskLow">Low Risk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot medium"></span>
                        <span data-i18n="riskMedium">Medium Risk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot high"></span>
                        <span data-i18n="riskHigh">High Risk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot critical"></span>
                        <span data-i18n="riskCritical">Critical Risk</span>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" data-i18n="statsTitle">Bali Flood Statistics</h2>
                    </div>
                    <div class="card-content">
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value">17+</div>
                                <div class="stat-label" data-i18n="majorFloods">Major Floods (5yr)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">6</div>
                                <div class="stat-label" data-i18n="regenciesAffected">Regencies Affected</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">66%</div>
                                <div class="stat-label" data-i18n="riskProbability">20yr Risk Prob.</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">Sep 2025</div>
                                <div class="stat-label" data-i18n="lastMajor">Last Major Event</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Region List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" data-i18n="regionListTitle">Investment Regions</h2>
                    </div>
                    <div class="card-content">
                        <div class="region-list" id="regionList"></div>
                    </div>
                    <div class="data-sources">
                        <div class="sources-title" data-i18n="dataSources">Official Data Sources</div>
                        <div class="sources-list">
                            <a href="https://gis.bnpb.go.id" target="_blank">BNPB Geoportal</a>
                            <a href="https://dibi.bnpb.go.id" target="_blank">DIBI</a>
                            <a href="https://inarisk.bnpb.go.id" target="_blank">inaRISK</a>
                            <a href="https://petabencana.id" target="_blank">PetaBencana</a>
                            <a href="https://thinkhazard.org" target="_blank">ThinkHazard</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-brand">Ryan Villa Investment Tools</div>
            <div data-i18n="footerNote">Data: BNPB, inaRISK, PetaBencana.id | For investment reference only</div>
        </footer>
    </div>

    <script>
        let currentLang = 'en';
        let map;
        let userMarker = null;
        let floodZones = [];

        const translations = {
            en: {
                subtitle: "Villa Investment Risk Assessment Tool",
                backToRoi: "← ROI Simulator",
                searchTitle: "Check Villa Address",
                searchDesc: "Enter a villa address to check flood risk at that location",
                searchPlaceholder: "Enter villa address in Bali...",
                searchBtn: "Check Risk",
                mapTitle: "Interactive Flood Risk Map",
                realtime: "Real-time",
                riskLow: "Low Risk",
                riskMedium: "Medium Risk",
                riskHigh: "High Risk",
                riskCritical: "Critical Risk",
                statsTitle: "Bali Flood Statistics",
                majorFloods: "Major Floods (5yr)",
                regenciesAffected: "Regencies Affected",
                riskProbability: "20yr Risk Prob.",
                lastMajor: "Last Major Event",
                regionListTitle: "Investment Regions",
                dataSources: "Official Data Sources",
                footerNote: "Data: BNPB, inaRISK, PetaBencana.id | For investment reference only",
                resultSafe: "Low Flood Risk Area",
                resultSafeDesc: "This location is in a relatively safe zone",
                resultWarning: "Moderate Flood Risk",
                resultWarningDesc: "Some flooding history in this area",
                resultDanger: "High Flood Risk Area",
                resultDangerDesc: "Significant flood events recorded nearby",
                nearestZone: "Nearest Area",
                distanceToRisk: "Distance to Risk",
                floodFrequency: "Area Flood Frequency",
                recommendation: "Recommendation",
                elevation: "Elevation",
                coordinates: "Coordinates",
                inFloodZone: "In Documented Flood Zone"
            },
            ko: {
                subtitle: "빌라 투자 위험 평가 도구",
                backToRoi: "← ROI 시뮬레이터",
                searchTitle: "빌라 주소 확인",
                searchDesc: "빌라 주소를 입력하여 침수 위험을 확인하세요",
                searchPlaceholder: "발리 빌라 주소 입력...",
                searchBtn: "위험 확인",
                mapTitle: "대화형 침수 위험 지도",
                realtime: "실시간",
                riskLow: "낮은 위험",
                riskMedium: "중간 위험",
                riskHigh: "높은 위험",
                riskCritical: "심각한 위험",
                statsTitle: "발리 침수 통계",
                majorFloods: "대형 침수 (5년)",
                regenciesAffected: "피해 지역",
                riskProbability: "20년 위험 확률",
                lastMajor: "최근 대형 침수",
                regionListTitle: "투자 지역",
                dataSources: "공식 데이터 출처",
                footerNote: "데이터: BNPB, inaRISK, PetaBencana.id | 투자 참고용",
                resultSafe: "침수 위험 낮은 지역",
                resultSafeDesc: "이 위치는 비교적 안전한 구역입니다",
                resultWarning: "중간 침수 위험",
                resultWarningDesc: "이 지역에 일부 침수 이력이 있습니다",
                resultDanger: "침수 위험 높은 지역",
                resultDangerDesc: "인근에 상당한 침수 사건이 기록되어 있습니다",
                nearestZone: "가장 가까운 지역",
                distanceToRisk: "위험 지역까지 거리",
                floodFrequency: "지역 침수 빈도",
                recommendation: "권고사항",
                elevation: "해발 고도",
                coordinates: "좌표",
                inFloodZone: "침수 피해 이력 지역"
            }
        };

        // Region data - Based on BNPB historical flood data 2020-2024
        // Note: Most areas are safe. Only specific low-lying spots have documented issues.
        const regions = [
            {
                id: 'canggu',
                name: 'Canggu',
                nameKo: '짱구',
                coords: [-8.6478, 115.1385],
                risk: 'medium',
                riskScore: 45,
                frequency: '1-2/year (localized)',
                recommendation: {
                    en: 'Most of Canggu is safe. Avoid low-lying areas near Semat River. Check elevation - above 10m is good.',
                    ko: '짱구 대부분은 안전. 세맛 강 인근 저지대만 주의. 해발 10m 이상이면 양호.'
                }
            },
            {
                id: 'seminyak',
                name: 'Seminyak',
                nameKo: '스미냑',
                coords: [-8.6913, 115.1683],
                risk: 'medium',
                riskScore: 50,
                frequency: '1-2/year (specific streets)',
                recommendation: {
                    en: 'Sunset Road junction has drainage issues. Most of Seminyak is fine. Check specific street history.',
                    ko: '선셋 로드 교차로에 배수 문제 있음. 스미냑 대부분은 양호. 구체적인 도로 이력 확인.'
                }
            },
            {
                id: 'ubud',
                name: 'Ubud',
                nameKo: '우붓',
                coords: [-8.5069, 115.2625],
                risk: 'low',
                riskScore: 25,
                frequency: 'Rare (valley floors only)',
                recommendation: {
                    en: 'Very safe overall. Only valley floor properties near rivers have minor risk. Hillside villas are excellent.',
                    ko: '전반적으로 매우 안전. 강 근처 계곡 바닥만 경미한 위험. 언덕 빌라는 우수.'
                }
            },
            {
                id: 'sanur',
                name: 'Sanur',
                nameKo: '사누르',
                coords: [-8.7089, 115.2621],
                risk: 'low',
                riskScore: 20,
                frequency: 'Very rare',
                recommendation: {
                    en: 'Excellent drainage infrastructure. Very safe for villa investment.',
                    ko: '배수 인프라 우수. 빌라 투자에 매우 안전.'
                }
            },
            {
                id: 'uluwatu',
                name: 'Uluwatu',
                nameKo: '울루와투',
                coords: [-8.8291, 115.0849],
                risk: 'low',
                riskScore: 5,
                frequency: 'None recorded',
                recommendation: {
                    en: 'Clifftop location - zero flood risk. Premium investment location.',
                    ko: '절벽 위치 - 침수 위험 제로. 프리미엄 투자 위치.'
                }
            },
            {
                id: 'nusadua',
                name: 'Nusa Dua',
                nameKo: '누사두아',
                coords: [-8.8005, 115.2316],
                risk: 'low',
                riskScore: 15,
                frequency: 'Very rare',
                recommendation: {
                    en: 'Resort-grade infrastructure. Excellent for investment.',
                    ko: '리조트급 인프라. 투자에 우수.'
                }
            },
            {
                id: 'kuta',
                name: 'Kuta/Legian',
                nameKo: '꾸따/레기안',
                coords: [-8.7180, 115.1690],
                risk: 'high',
                riskScore: 65,
                frequency: '2-3/year (central area)',
                recommendation: {
                    en: 'Central Kuta has documented flooding. Consider other areas for villa investment. Street-level flooding mainly affects shops.',
                    ko: '꾸따 중심부 침수 기록 있음. 빌라 투자는 다른 지역 고려. 도로 침수는 주로 상가에 영향.'
                }
            },
            {
                id: 'denpasar',
                name: 'Denpasar',
                nameKo: '덴파사르',
                coords: [-8.6705, 115.2126],
                risk: 'medium',
                riskScore: 40,
                frequency: '1-2/year (urban drainage)',
                recommendation: {
                    en: 'Urban area with some drainage issues. Not typically a villa investment zone anyway.',
                    ko: '일부 배수 문제 있는 도시 지역. 일반적으로 빌라 투자 지역 아님.'
                }
            }
        ];

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ko' : 'en';
            document.getElementById('langToggleText').textContent = currentLang === 'en' ? '한국어' : 'English';
            applyTranslations();
            renderRegionList();
        }

        function applyTranslations() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });
        }

        function getRiskColor(risk) {
            switch(risk) {
                case 'low': return '#22c55e';
                case 'medium': return '#eab308';
                case 'high': return '#f97316';
                case 'critical': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function getRiskLabel(risk) {
            const t = translations[currentLang];
            switch(risk) {
                case 'low': return t.riskLow;
                case 'medium': return t.riskMedium;
                case 'high': return t.riskHigh;
                case 'critical': return t.riskCritical;
                default: return risk;
            }
        }

        function initMap() {
            map = L.map('map').setView([-8.65, 115.2], 11);

            // Base map layer
            const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Satellite layer option
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri'
            });

            // BNPB Flood Hazard WMS Layer
            const bnpbFloodLayer = L.tileLayer.wms('https://gis.bnpb.go.id/server/services/inarisk/layer_bahaya_banjir_30/MapServer/WMSServer', {
                layers: '0',
                format: 'image/png',
                transparent: true,
                opacity: 0.5,
                attribution: 'BNPB inaRISK'
            });

            // Add major flood-prone area overlays with smooth, natural shapes
            addFloodOverlays();

            // Add region markers
            regions.forEach(region => {
                const color = getRiskColor(region.risk);

                // Add region marker
                const marker = L.circleMarker(region.coords, {
                    radius: 16,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                const name = currentLang === 'ko' ? region.nameKo : region.name;

                marker.bindPopup(`
                    <div class="popup-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${color}" stroke="${color}" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3" fill="white"/></svg> ${name}</div>
                    <span class="popup-risk risk-badge ${region.risk}">${getRiskLabel(region.risk)}</span>
                    <p class="popup-desc">${region.recommendation[currentLang]}</p>
                    <div style="margin-top:10px;font-size:12px;">
                        <strong>Flood Frequency:</strong> ${region.frequency}
                    </div>
                `);

                marker.on('click', () => {
                    map.flyTo(region.coords, 14);
                });
            });

            // Layer control
            const baseMaps = {
                "Map": baseLayer,
                "Satellite": satelliteLayer
            };
            const overlays = {
                "BNPB Flood Hazard": bnpbFloodLayer
            };
            L.control.layers(baseMaps, overlays, { position: 'topright' }).addTo(map);
        }

        // Add flood overlays based on documented flood events 2020-2024
        function addFloodOverlays() {

            // ===========================================
            // KUTA/LEGIAN/TUBAN: Highest flood frequency area
            // ===========================================
            // Central Kuta - main flood zone
            const kutaCentral = L.polygon([
                [-8.7100, 115.1650], [-8.7080, 115.1700], [-8.7100, 115.1760],
                [-8.7150, 115.1800], [-8.7220, 115.1820], [-8.7280, 115.1800],
                [-8.7320, 115.1750], [-8.7300, 115.1680], [-8.7250, 115.1640],
                [-8.7180, 115.1630], [-8.7130, 115.1640]
            ], {
                color: '#dc2626',
                fillColor: '#dc2626',
                fillOpacity: 0.35,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            kutaCentral.bindPopup('<b>Central Kuta</b><br>Flood frequency: 2-3x/year<br>Street flooding 30-80cm reported');
            floodZones.push({ polygon: kutaCentral, region: regions.find(r => r.id === 'kuta') });

            // Legian area
            const legianArea = L.polygon([
                [-8.6980, 115.1660], [-8.6960, 115.1710], [-8.6980, 115.1770],
                [-8.7030, 115.1800], [-8.7090, 115.1790], [-8.7120, 115.1740],
                [-8.7100, 115.1680], [-8.7050, 115.1650], [-8.7010, 115.1650]
            ], {
                color: '#dc2626',
                fillColor: '#dc2626',
                fillOpacity: 0.3,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            legianArea.bindPopup('<b>Legian</b><br>Recurring street flooding<br>Drainage issues documented');
            floodZones.push({ polygon: legianArea, region: regions.find(r => r.id === 'kuta') });

            // Tuban near airport
            const tubanArea = L.polygon([
                [-8.7350, 115.1620], [-8.7320, 115.1680], [-8.7350, 115.1750],
                [-8.7420, 115.1800], [-8.7500, 115.1780], [-8.7530, 115.1720],
                [-8.7500, 115.1650], [-8.7430, 115.1610], [-8.7380, 115.1610]
            ], {
                color: '#dc2626',
                fillColor: '#dc2626',
                fillOpacity: 0.28,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            tubanArea.bindPopup('<b>Tuban Area</b><br>Near airport road flooding<br>Low-lying terrain');
            floodZones.push({ polygon: tubanArea, region: regions.find(r => r.id === 'kuta') });

            // ===========================================
            // SEMINYAK: Sunset Road corridor
            // ===========================================
            const sunsetRoad = L.polygon([
                [-8.6920, 115.1580], [-8.6900, 115.1640], [-8.6920, 115.1710],
                [-8.6970, 115.1760], [-8.7040, 115.1780], [-8.7100, 115.1750],
                [-8.7120, 115.1680], [-8.7080, 115.1620], [-8.7020, 115.1580],
                [-8.6970, 115.1570]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.32,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            sunsetRoad.bindPopup('<b>Sunset Road Area</b><br>Annual monsoon flooding<br>50-100cm documented');
            floodZones.push({ polygon: sunsetRoad, region: regions.find(r => r.id === 'seminyak') });

            // Tukad Mati corridor
            const tukadMati = L.polygon([
                [-8.6800, 115.1720], [-8.6780, 115.1780], [-8.6820, 115.1850],
                [-8.6880, 115.1890], [-8.6950, 115.1880], [-8.6980, 115.1820],
                [-8.6950, 115.1760], [-8.6890, 115.1720], [-8.6840, 115.1710]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.3,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            tukadMati.bindPopup('<b>Tukad Mati Basin</b><br>River overflow during heavy rain<br>Properties near river affected');
            floodZones.push({ polygon: tukadMati, region: regions.find(r => r.id === 'seminyak') });

            // Petitenget low area
            const petitenget = L.polygon([
                [-8.6720, 115.1600], [-8.6700, 115.1660], [-8.6730, 115.1720],
                [-8.6790, 115.1740], [-8.6850, 115.1710], [-8.6860, 115.1650],
                [-8.6820, 115.1600], [-8.6770, 115.1590]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.25,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            petitenget.bindPopup('<b>Petitenget</b><br>Occasional flooding<br>Lower risk than Sunset Road');
            floodZones.push({ polygon: petitenget, region: regions.find(r => r.id === 'seminyak') });

            // ===========================================
            // CANGGU: River and rice field areas
            // ===========================================
            // Berawa lowlands
            const berawa = L.polygon([
                [-8.6550, 115.1520], [-8.6520, 115.1590], [-8.6550, 115.1670],
                [-8.6620, 115.1730], [-8.6700, 115.1750], [-8.6760, 115.1710],
                [-8.6780, 115.1640], [-8.6740, 115.1570], [-8.6680, 115.1530],
                [-8.6610, 115.1510]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.3,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            berawa.bindPopup('<b>Berawa Lowlands</b><br>Rice field drainage issues<br>Ground floor flooding risk');
            floodZones.push({ polygon: berawa, region: regions.find(r => r.id === 'canggu') });

            // Batu Bolong / Echo Beach corridor
            const batuBolong = L.polygon([
                [-8.6430, 115.1280], [-8.6400, 115.1350], [-8.6430, 115.1430],
                [-8.6500, 115.1490], [-8.6570, 115.1480], [-8.6620, 115.1420],
                [-8.6600, 115.1340], [-8.6540, 115.1280], [-8.6480, 115.1270]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.28,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            batuBolong.bindPopup('<b>Batu Bolong Area</b><br>Coastal + river flooding<br>2021, 2022 events documented');
            floodZones.push({ polygon: batuBolong, region: regions.find(r => r.id === 'canggu') });

            // Semat River corridor
            const sematRiver = L.polygon([
                [-8.6350, 115.1180], [-8.6320, 115.1250], [-8.6360, 115.1330],
                [-8.6420, 115.1380], [-8.6490, 115.1370], [-8.6520, 115.1300],
                [-8.6480, 115.1220], [-8.6420, 115.1180], [-8.6380, 115.1170]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.28,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            sematRiver.bindPopup('<b>Semat River Area</b><br>River overflow zone<br>Avoid properties near riverbank');
            floodZones.push({ polygon: sematRiver, region: regions.find(r => r.id === 'canggu') });

            // ===========================================
            // DENPASAR: Urban drainage issues
            // ===========================================
            // City center
            const denpasarCenter = L.polygon([
                [-8.6620, 115.2080], [-8.6600, 115.2150], [-8.6640, 115.2220],
                [-8.6720, 115.2270], [-8.6800, 115.2260], [-8.6850, 115.2200],
                [-8.6830, 115.2120], [-8.6770, 115.2070], [-8.6700, 115.2060]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.28,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            denpasarCenter.bindPopup('<b>Denpasar Center</b><br>Urban drainage overflow<br>Street flooding during monsoon');
            floodZones.push({ polygon: denpasarCenter, region: regions.find(r => r.id === 'denpasar') });

            // Sesetan area
            const sesetan = L.polygon([
                [-8.6900, 115.2100], [-8.6880, 115.2170], [-8.6920, 115.2240],
                [-8.6990, 115.2280], [-8.7060, 115.2250], [-8.7080, 115.2180],
                [-8.7040, 115.2110], [-8.6970, 115.2080]
            ], {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.25,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            sesetan.bindPopup('<b>Sesetan</b><br>Low-lying urban area<br>Occasional flooding');
            floodZones.push({ polygon: sesetan, region: regions.find(r => r.id === 'denpasar') });

            // ===========================================
            // UBUD: Valley areas
            // ===========================================
            // Campuhan valley
            const campuhan = L.polygon([
                [-8.5020, 115.2550], [-8.5000, 115.2620], [-8.5040, 115.2700],
                [-8.5110, 115.2750], [-8.5180, 115.2730], [-8.5200, 115.2660],
                [-8.5160, 115.2580], [-8.5100, 115.2540], [-8.5050, 115.2540]
            ], {
                color: '#eab308',
                fillColor: '#eab308',
                fillOpacity: 0.28,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            campuhan.bindPopup('<b>Campuhan Valley</b><br>Valley floor flooding<br>Hillside properties safe');
            floodZones.push({ polygon: campuhan, region: regions.find(r => r.id === 'ubud') });

            // Ubud center low area
            const ubudLow = L.polygon([
                [-8.5080, 115.2610], [-8.5060, 115.2670], [-8.5090, 115.2730],
                [-8.5150, 115.2760], [-8.5210, 115.2740], [-8.5230, 115.2680],
                [-8.5200, 115.2620], [-8.5140, 115.2600]
            ], {
                color: '#eab308',
                fillColor: '#eab308',
                fillOpacity: 0.22,
                weight: 1.5,
                smoothFactor: 2
            }).addTo(map);
            ubudLow.bindPopup('<b>Ubud Low Area</b><br>Minor flooding risk<br>Most of Ubud is safe');
            floodZones.push({ polygon: ubudLow, region: regions.find(r => r.id === 'ubud') });

            // ===========================================
            // SANUR: Minor coastal zone
            // ===========================================
            const sanurCoast = L.polygon([
                [-8.7000, 115.2650], [-8.6980, 115.2700], [-8.7020, 115.2750],
                [-8.7100, 115.2780], [-8.7180, 115.2770], [-8.7220, 115.2720],
                [-8.7180, 115.2660], [-8.7100, 115.2640], [-8.7040, 115.2640]
            ], {
                color: '#22c55e',
                fillColor: '#22c55e',
                fillOpacity: 0.2,
                weight: 1,
                smoothFactor: 2
            }).addTo(map);
            sanurCoast.bindPopup('<b>Sanur Beach Area</b><br>Very low risk<br>King tide minor flooding only');
            floodZones.push({ polygon: sanurCoast, region: regions.find(r => r.id === 'sanur') });

            // Add river lines for reference
            addRiverLines();
        }

        // River lines for geographical context
        function addRiverLines() {
            const rivers = [
                { name: 'Tukad Petanu', coords: [[-8.6200, 115.1100], [-8.6400, 115.1250], [-8.6550, 115.1450], [-8.6680, 115.1700]] },
                { name: 'Tukad Mati', coords: [[-8.6700, 115.1650], [-8.6850, 115.1800], [-8.7000, 115.1900]] },
                { name: 'Tukad Badung', coords: [[-8.6500, 115.2000], [-8.6700, 115.2150], [-8.6900, 115.2300]] }
            ];

            rivers.forEach(river => {
                L.polyline(river.coords, {
                    color: '#0ea5e9',
                    weight: 2,
                    opacity: 0.5,
                    dashArray: '6, 4'
                }).addTo(map).bindPopup(river.name);
            });
        }

        function renderRegionList() {
            const container = document.getElementById('regionList');
            container.innerHTML = regions.map(region => {
                const name = currentLang === 'ko' ? region.nameKo : region.name;
                const color = getRiskColor(region.risk);

                return `
                    <div class="region-item" onclick="focusRegion('${region.id}')">
                        <div class="region-info">
                            <div class="region-icon" style="background: ${color}20;"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${color}" stroke="${color}" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3" fill="white"/></svg></div>
                            <div class="region-name">${name}</div>
                        </div>
                        <span class="risk-badge ${region.risk}">${region.riskScore}</span>
                    </div>
                `;
            }).join('');
        }

        function focusRegion(regionId) {
            const region = regions.find(r => r.id === regionId);
            if (region) {
                map.flyTo(region.coords, 14);
            }
        }

        // Address search using Nominatim (OpenStreetMap)
        async function searchAddress() {
            const address = document.getElementById('addressInput').value;
            if (!address) return;

            const resultDiv = document.getElementById('searchResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'search-result';
            resultDiv.innerHTML = '<div style="text-align:center;padding:20px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px;"><circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"/></svg>Searching...</div>';

            try {
                // Use Nominatim for geocoding
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Bali, Indonesia')}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    // Fetch elevation data
                    let elevation = null;
                    try {
                        const elevResponse = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`);
                        const elevData = await elevResponse.json();
                        if (elevData.results && elevData.results[0]) {
                            elevation = elevData.results[0].elevation;
                        }
                    } catch (e) {
                        console.log('Elevation API unavailable');
                    }

                    // Remove existing user marker
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    // Add new marker
                    userMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);

                    const elevText = elevation !== null ? ` | Elevation: ${elevation}m` : '';
                    userMarker.bindPopup(`<b>Your Villa Location</b><br>${data[0].display_name}${elevText}`).openPopup();

                    map.flyTo([lat, lon], 16);

                    // Check flood risk
                    const riskResult = checkFloodRisk(lat, lon);
                    riskResult.elevation = elevation;
                    riskResult.lat = lat;
                    riskResult.lon = lon;
                    displaySearchResult(riskResult, data[0].display_name);

                } else {
                    resultDiv.className = 'search-result warning';
                    resultDiv.innerHTML = `
                        <div class="result-header">
                            <span class="result-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></span>
                            <div>
                                <div class="result-title">Address Not Found</div>
                                <div class="result-subtitle">Try a more specific address or nearby landmark</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'search-result warning';
                resultDiv.innerHTML = `
                    <div class="result-header">
                        <span class="result-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></span>
                        <div>
                            <div class="result-title">Search Error</div>
                            <div class="result-subtitle">${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }

        function checkFloodRisk(lat, lon) {
            const t = translations[currentLang];
            let nearestRegion = null;
            let minDistance = Infinity;
            let inFloodZone = false;
            let floodZoneRisk = null;

            // Check each region for nearest
            regions.forEach(region => {
                const distance = getDistance(lat, lon, region.coords[0], region.coords[1]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestRegion = region;
                }
            });

            // Check if point is inside any flood zone polygon
            const point = L.latLng(lat, lon);
            floodZones.forEach(fz => {
                if (fz.polygon && fz.region) {
                    const bounds = fz.polygon.getBounds();
                    if (bounds.contains(point)) {
                        // More precise check using ray casting
                        const latlngs = fz.polygon.getLatLngs()[0];
                        if (isPointInLeafletPolygon(lat, lon, latlngs)) {
                            inFloodZone = true;
                            floodZoneRisk = fz.region;
                        }
                    }
                }
            });

            // If in flood zone, use that region's risk level
            if (inFloodZone && floodZoneRisk) {
                nearestRegion = floodZoneRisk;
            }

            // Determine risk level
            let riskLevel, riskClass;
            if (inFloodZone) {
                riskLevel = 'danger';
                riskClass = 'danger';
            } else if (nearestRegion && nearestRegion.riskScore >= 70 && minDistance < 1.5) {
                riskLevel = 'danger';
                riskClass = 'danger';
            } else if (nearestRegion && nearestRegion.riskScore >= 40 && minDistance < 2.5) {
                riskLevel = 'warning';
                riskClass = 'warning';
            } else {
                riskLevel = 'safe';
                riskClass = 'safe';
            }

            return {
                riskLevel,
                riskClass,
                nearestRegion,
                distance: minDistance,
                inFloodZone
            };
        }

        // Check if point is inside Leaflet polygon using ray casting
        function isPointInLeafletPolygon(lat, lon, latlngs) {
            let inside = false;
            const x = lon, y = lat;

            for (let i = 0, j = latlngs.length - 1; i < latlngs.length; j = i++) {
                const xi = latlngs[i].lng, yi = latlngs[i].lat;
                const xj = latlngs[j].lng, yj = latlngs[j].lat;

                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        function displaySearchResult(result, address) {
            const t = translations[currentLang];
            const resultDiv = document.getElementById('searchResult');

            let icon, title, desc;
            if (result.riskLevel === 'danger') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                title = t.resultDanger;
                desc = t.resultDangerDesc;
            } else if (result.riskLevel === 'warning') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
                title = t.resultWarning;
                desc = t.resultWarningDesc;
            } else {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                title = t.resultSafe;
                desc = t.resultSafeDesc;
            }

            const regionName = result.nearestRegion ?
                (currentLang === 'ko' ? result.nearestRegion.nameKo : result.nearestRegion.name) : 'Unknown';

            // Elevation interpretation
            let elevationDisplay = '-';
            let elevationNote = '';
            if (result.elevation !== null && result.elevation !== undefined) {
                elevationDisplay = `${result.elevation}m`;
                if (result.elevation < 5) {
                    elevationNote = currentLang === 'ko' ? ' (저지대 - 주의)' : ' (Low-lying - Caution)';
                } else if (result.elevation < 15) {
                    elevationNote = currentLang === 'ko' ? ' (보통)' : ' (Moderate)';
                } else {
                    elevationNote = currentLang === 'ko' ? ' (고지대 - 양호)' : ' (Elevated - Good)';
                }
            }

            // Coordinates display
            const coordsDisplay = result.lat && result.lon ?
                `${result.lat.toFixed(5)}, ${result.lon.toFixed(5)}` : '-';

            resultDiv.className = `search-result ${result.riskClass}`;
            resultDiv.innerHTML = `
                <div class="result-header">
                    <span class="result-icon">${icon}</span>
                    <div>
                        <div class="result-title">${title}</div>
                        <div class="result-subtitle">${desc}</div>
                    </div>
                </div>
                <div class="result-details">
                    <div class="result-item">
                        <div class="result-label">${t.elevation || 'Elevation'}</div>
                        <div class="result-value" style="font-weight:600;color:${result.elevation < 5 ? '#f59e0b' : result.elevation >= 15 ? '#22c55e' : 'inherit'};">${elevationDisplay}${elevationNote}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.coordinates || 'Coordinates'}</div>
                        <div class="result-value" style="font-size:11px;">${coordsDisplay}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.nearestZone}</div>
                        <div class="result-value">${regionName}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.inFloodZone || 'In Flood Zone'}</div>
                        <div class="result-value" style="font-weight:600;color:${result.inFloodZone ? '#ef4444' : '#22c55e'};">${result.inFloodZone ? (currentLang === 'ko' ? '예 - 피해이력 있음' : 'Yes - Documented') : (currentLang === 'ko' ? '아니오' : 'No')}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.floodFrequency}</div>
                        <div class="result-value">${result.nearestRegion?.frequency || 'N/A'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">${t.recommendation}</div>
                        <div class="result-value" style="font-size:12px;">${result.nearestRegion?.recommendation[currentLang] || '-'}</div>
                    </div>
                </div>
            `;
        }

        // Helper: Calculate distance between two points (km)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Helper: Check if point is in polygon
        function isPointInPolygon(point, polygon) {
            if (!polygon || polygon.length < 3) return false;

            let inside = false;
            const x = point[0], y = point[1];

            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];

                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }

            return inside;
        }

        // Enter key search
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addressInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchAddress();
            });

            initMap();
            renderRegionList();
        });
    </script>
</body>
</html>
